---
title: "Power Analysis"
author: "Vic Quennessen"
date: "10/12/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# load libraries
library(ggplot2)
library(viridisLite)
library(tidyverse)
```

## Power analysis

Question 1: How many hatchlings should be sampled from a nest to robustly estimate the number of males that contributed to it?

```{r, echo = FALSE, warning = FALSE, message = FALSE, cache = TRUE}

# population parameters
n_eggs         <- 100    # number of eggs per nest
max_hatchlings <- 100    # maximum number of hatchlings that can be sampled
max_males      <- 10     # maximum number of males females can mate with
max_eggs       <- min(max_hatchlings, n_eggs) 

# model parameters
n_sims         <- 100000

# pre-allocate data frame
DF <- data.frame(Males = rep(1:max_males, each = (max_eggs - 1)), 
                 Sample_size = rep(2:max_eggs, times = max_males), 
                 Proportion_correct = rep(NA, dim = max_males*(max_eggs - 1)))

# for each number of males that contribute to a nest:
for (i in 1:max_males) {
  
  # proportion_correct array
  prop_correct <- rep(NA, n_sims)
  
  # for each sample size
  for (j in 2:max_eggs) {
    
    # pre-allocate correct identifications of number of males
    correct <- rep(NA, n_sims)
    
    for (k in 1:n_sims) {
      
      # simulate male contributions to nest
      nest <- sample(1:i, size = max_eggs, replace = TRUE)
      
      # take samples of size k
      samples <- sample(nest, size = j, replace = FALSE)
      
      # correct allocation of number of males?
      correct[k] <- length(unique(samples)) == i
      
    }
    
    # calculate index in data frame
    index <- (i - 1)*(max_eggs - 1) + j - 1
    
    # stick proportion in data frame
    DF$Proportion_correct[index] <- mean(correct)
  }
  
}

#### plot results

# color-blind friendly color palette
colors <- viridis(max_males)

# plot results
ggplot(DF, aes(x = Sample_size, y = Proportion_correct, 
               col = as.factor(Males))) +
  geom_path(lwd = 1) +
  labs(col = 'Number \n of Males') +
  scale_color_manual(values = colors) 
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, cache = TRUE}

##### check if results change with different nest sizes
# they do NOT

# # population parameters
# max_males      <- 10     # maximum number of males females can mate with
# 
# # model parameters
# n_sims         <- 1000
# 
# # different numbers of eggs
# n_eggs <- c(50, 100, 250)
# 
# for (e in 1:length(n_eggs)) {
#   
#   # pre-allocate data frame
#   DF <- data.frame(Males = rep(1:max_males, each = (n_eggs[e] - 1)), 
#                    Sample_size = rep(2:n_eggs[e], times = max_males), 
#                    Proportion_correct = rep(NA, dim = max_males*(n_eggs[e] - 1)))
#   
#   # for each number of males that contribute to a nest:
#   for (i in 1:max_males) {
#     
#     # proportion_correct array
#     prop_correct <- rep(NA, n_sims)
#     
#     # for each sample size
#     for (j in 2:n_eggs[e]) {
#       
#       # pre-allocate correct identifications of number of males
#       correct <- rep(NA, n_sims)
#       
#       for (k in 1:n_sims) {
#         
#         # simulate male contributions to nest
#         nest <- sample(1:i, size = n_eggs[e], replace = TRUE)
#         
#         # take samples of size k
#         samples <- sample(nest, size = j, replace = FALSE)
#         
#         # correct allocation of number of males?
#         correct[k] <- length(unique(samples)) == i
#         
#       }
#       
#       # calculate index in data frame
#       index <- (i - 1)*(n_eggs[e] - 1) + j - 1
#       
#       # stick proportion in data frame
#       DF$Proportion_correct[index] <- mean(correct)
#     }
#     
#   }
#   
#   # add number of eggs column
#   DF$Number_of_eggs <- n_eggs[e]
#   
#   # save DF as one of three DFs
#   if (e == 1) {DF1 <- DF} else if (e == 2) {DF2 <- DF} else {DF3 <- DF}
# }
# 
# DF <- rbind(DF1, DF2, DF3)
# 
# # color-blind friendly color palette
# colors <- viridis(max_males)
# 
# # plot results
# ggplot(DF, aes(x = Sample_size, y = Proportion_correct, 
#                col = as.factor(Males), 
#                linetype = as.factor(Number_of_eggs))) +
#   geom_path(lwd = 1) +
#   labs(col = 'Number \n of Males') +
#   scale_color_manual(values = colors) 
```



How many hatchlings should be taken for each cutoff value?

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# print table of minimum sample sizes for robust estimate
cutoffs <- c(0.999, 0.99, 0.95, 0.9)
DF2 <- tibble(Males = rep(paste(2:max_males, ' Males', sep = ''), 
                          each = length(cutoffs)), 
              Cutoff = rep(cutoffs, times = (max_males - 1)), 
              Value = rep(NA, times = length(cutoffs)*(max_males - 1)))

# for each number of males
for (i in 2:max_males) {
  
  # extract just values for number of males
  MA <- subset(DF, Males == i)
  
  # for each cutoff value
  for (j in 1:length(cutoffs)) {
    index <- (i - 2)*length(cutoffs) + j
    
    DF2$Value[index] <- min(which(MA$Proportion_correct >= cutoffs[j]))
  }
}

# column names
column_names <- paste(1:max_males, ' Males', sep = '')

# print out table
output <- pivot_wider(DF2, id_cols = Cutoff, names_from = Males, 
                      values_from = Value)

knitr::kable(output, align = 'c')
```

\newpage

Question 2: How many females and nests should be sampled to get a robust estimate of the number of breeding males, and therefore the breeding sex ratio?

```{r}
minM <- 10  # minimum number of males in one breeding year
maxM <- 100 # maximum number of males in one breeding year
maxF <- 100 # maximum number of females in one breeding year
Mprob <- rep(1/6, times = 6) # equal probability of mating with 0-5 males
mating_mode <- 'polyamory' # options are 'polygyny' (males mate with multiple females but females mate with a single male) and 'polyamory' (both males and females have multiple partners)

for (i in minM:maxM) {
  
  # build pool of potential males to mate with
  Mpool <- rep(1:maxM, times = maxF)
  
  for (j in 50:maxF) {
    
    # simulate breeding
    if (mating_mode == 'polygyny') {
      
      mates <- sample(Mpool, size = j, replace = FALSE)
      
    } else if (mating_mode == 'polyamory') {
      
      for (k in 1:j) {
         
      }
      
    }
    
  }
  
}
```

